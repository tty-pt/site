#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 1 ]]; then
  echo "usage: ./mod-add <module-id>" >&2
  exit 1
fi

mod_id="$1"
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

db_path="${script_dir}/module.db"
mods_load="${script_dir}/mods.load"

rm -f "$db_path" "$mods_load"

python3 "${script_dir}/scripts/gen_mods.py" \
  --mods-dir "${script_dir}/mods" \
  --mods-load "$mods_load" \
  --roots "$mod_id" | while read -r line; do
    qmap -p "$line" "$db_path"
  done

chmod 644 "$db_path" "$mods_load"
